<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Callio ‚Äì In Call</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" />
  <style>
    :root {
      --bg: #0f172a; --fg: #f8fafc; --secondary: #334155;
      --accent: #3b82f6; --error: #ef4444;
    }
    body {
      background: var(--bg); color: var(--fg); font-family: 'Inter', sans-serif;
      margin:0; display:flex; flex-direction:column;
      height:100vh; align-items:center; justify-content:center;
      gap:20px; padding:1rem;
    }
    .label { font-size:1.25rem; font-weight:600; }
    .video-container {
      display:flex; gap:20px;
    }
    video {
      width:140px; height:140px; background:var(--secondary);
      border-radius:12px; object-fit:cover;
    }
    .controls {
      display:flex; gap:16px;
    }
    button {
      padding:12px; font-size:18px; border:none;
      border-radius:10px; cursor:pointer;
      background:var(--secondary); color:var(--fg);
      transition:background 0.2s;
    }
    button:hover { background: var(--accent); }
    #end { background:var(--error); color:white; }
  </style>
</head>
<body>
  <div class="label">Room: <span id="room-span">‚Äî</span></div>

  <div class="video-container">
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <div class="controls">
    <button id="mic-btn">üîá Mute</button>
    <button id="end">‚ùå End Call</button>
  </div>

  <script type="module">
    import { io } from 'https://cdn.socket.io/4.7.2/socket.io.esm.min.js';

    const roomId = new URLSearchParams(location.search).get('id');
    if (!roomId) location.href = 'index.html';

    document.getElementById('room-span').textContent = roomId;

    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const micBtn = document.getElementById('mic-btn');
    const endBtn = document.getElementById('end');

    const socket = io('https://callio.onrender.com', { transports: ['polling', 'websocket'] });
    let pc, localStream;

    socket.on('connect', () => {
      socket.emit('join', roomId);
    });

    socket.on('signal', async data => {
      if (!pc) return;
      if (data.sdp) {
        await pc.setRemoteDescription(data);
        if (data.type === 'offer') {
          const ans = await pc.createAnswer();
          await pc.setLocalDescription(ans);
          socket.emit('signal', { roomId, payload: pc.localDescription });
        }
      } else if (data.candidate) {
        await pc.addIceCandidate(data);
      }
    });

    async function start() {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
      localVideo.srcObject = localStream;

      pc = new RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
      });

      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

      pc.onicecandidate = e => {
        if (e.candidate) {
          socket.emit('signal', { roomId, payload: e.candidate });
        }
      };

      pc.ontrack = e => {
        remoteVideo.srcObject = e.streams[0];
      };

      pc.onnegotiationneeded = async () => {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        socket.emit('signal', { roomId, payload: pc.localDescription });
      };
    }

    micBtn.onclick = () => {
      const audioTrack = localStream.getAudioTracks()[0];
      audioTrack.enabled = !audioTrack.enabled;
      micBtn.textContent = audioTrack.enabled ? 'üîá Mute' : 'üé§ Unmute';
    };

    endBtn.onclick = () => {
      pc && pc.close();
      socket.disconnect();
      location.href = 'index.html';
    };

    start().catch(err => alert('Microphone access error: ' + err.message));
  </script>
</body>
</html>
