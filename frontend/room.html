<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Callio Room</title>
  <style>
    :root {
      --bg-color: #0f172a;
      --card-color: #1e293b;
      --text-color: #f1f5f9;
      --accent-color: #3b82f6;
      --accent-hover: #2563eb;
      --border-color: #334155;
    }
    body {
      background: var(--bg-color);
      color: var(--text-color);
      font-family: 'Inter', sans-serif;
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 1rem 1.5rem;
      background: var(--card-color);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    h2 {
      font-size: 1rem;
      margin: 0;
      font-weight: 500;
    }
    #room-code {
      color: var(--accent-color);
      font-weight: bold;
      font-size: 1rem;
    }
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1.5rem;
      gap: 1.5rem;
    }
    .video-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }
    video {
      width: 100%;
      max-width: 500px;
      border-radius: 12px;
      border: 2px solid var(--border-color);
      background: black;
      aspect-ratio: 16 / 9;
    }
    .user-tag {
      font-size: 0.875rem;
      color: #94a3b8;
      text-align: center;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      margin-top: 1rem;
    }
    button.control {
      background: var(--accent-color);
      color: white;
      border: none;
      padding: 0.75rem 1.25rem;
      font-size: 0.9rem;
      border-radius: 8px;
      cursor: pointer;
    }
    button.control:hover {
      background: var(--accent-hover);
    }
    #waiting {
      margin-top: 1rem;
      font-size: 0.95rem;
      color: #cbd5e1;
    }
    .toast {
      position: fixed;
      bottom: 16px;
      right: 16px;
      background: var(--card-color);
      color: var(--text-color);
      padding: 12px 16px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      animation: fadeout 3s forwards;
    }
    @keyframes fadeout {
      0% { opacity: 1; }
      80% { opacity: 1; }
      100% { opacity: 0; transform: translateY(20px); }
    }
    .emoji-bar span {
      font-size: 1.5rem;
      cursor: pointer;
      margin: 0 0.25rem;
    }
  </style>
</head>
<body>
  <header>
    <h2>Room Code: <span id="room-code"></span></h2>
    <button id="leave-btn" class="control">Leave</button>
  </header>

  <section class="main">
    <div class="video-container">
      <video id="local-video" autoplay muted playsinline></video>
      <div class="user-tag" id="local-name">You</div>
    </div>

    <div class="video-container">
      <video id="remote-video" autoplay playsinline></video>
      <div class="user-tag" id="remote-name">Waiting...</div>
    </div>

    <div id="waiting">‚è≥ Waiting for peer to join...</div>
  </section>

  <div class="controls">
    <button id="mute-btn" class="control">Mute</button>
    <button id="camera-btn" class="control">Hide Camera</button>
    <button id="flip-btn" class="control">Flip Camera</button>
    <button id="audio-only-btn" class="control">Audio Only</button>
    <button id="emoji-btn" class="control">üòä</button>
    <button id="share-btn" class="control">Share</button>
  </div>
  <div class="emoji-bar" style="text-align:center; margin-top:0.5rem;">
    <span onclick="sendEmoji('üëç')">üëç</span>
    <span onclick="sendEmoji('üòÇ')">üòÇ</span>
    <span onclick="sendEmoji('üî•')">üî•</span>
    <span onclick="sendEmoji('üòÆ')">üòÆ</span>
  </div>
  <div id="toast-area"></div>

  <script>
    const signalingServer = "wss://callio.onrender.com";
    const ws = new WebSocket(signalingServer);
    const roomId = new URLSearchParams(window.location.search).get("id");
    const isCreator = localStorage.getItem("isCreator") === "true";
    const userName = localStorage.getItem("userName") || "You";

    document.getElementById("room-code").textContent = roomId;
    document.getElementById("local-name").textContent = userName;

    function showToast(msg) {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.textContent = msg;
      document.getElementById("toast-area").appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    document.getElementById("share-btn").onclick = () => {
      const link = `${window.location.origin}${window.location.pathname}?id=${roomId}`;
      navigator.clipboard.writeText(link).then(() => showToast("Link copied!"));
    };
    document.getElementById("leave-btn").onclick = () => {
      window.location.href = "index.html";
    };

    let localStream, remoteStream, videoInputDeviceId = null;
    const localVideo = document.getElementById("local-video");
    const remoteVideo = document.getElementById("remote-video");

    const peer = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });

    async function initStream() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(d => d.kind === "videoinput");
      const constraints = {
        video: videoInputDeviceId ? { deviceId: { exact: videoInputDeviceId } } : true,
        audio: true
      };
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      localStream = stream;
      localVideo.srcObject = stream;
      stream.getTracks().forEach(track => peer.addTrack(track, stream));
    }

    initStream();

    peer.ontrack = (event) => {
      if (!remoteStream) {
        remoteStream = new MediaStream();
        remoteVideo.srcObject = remoteStream;
        document.getElementById("waiting").style.display = "none";
        document.getElementById("remote-name").textContent = "Connected";
      }
      remoteStream.addTrack(event.track);
    };

    peer.onicecandidate = (event) => {
      if (event.candidate) {
        ws.send(JSON.stringify({
          type: "signal",
          roomId,
          payload: { candidate: event.candidate }
        }));
      }
    };

    ws.onopen = () => {
      ws.send(JSON.stringify({ type: "join", roomId, name: userName }));
      if (isCreator) {
        peer.createOffer().then(offer => {
          peer.setLocalDescription(offer);
          ws.send(JSON.stringify({ type: "signal", roomId, payload: { sdp: offer } }));
        });
      }
    };

    ws.onmessage = async (msg) => {
      const { type, payload, from } = JSON.parse(msg.data);
      if (type === "signal") {
        if (payload.sdp) {
          await peer.setRemoteDescription(new RTCSessionDescription(payload.sdp));
          if (payload.sdp.type === "offer") {
            const answer = await peer.createAnswer();
            await peer.setLocalDescription(answer);
            ws.send(JSON.stringify({ type: "signal", roomId, payload: { sdp: answer } }));
          }
        }
        if (payload.candidate) {
          await peer.addIceCandidate(new RTCIceCandidate(payload.candidate));
        }
      }
      if (type === "emoji") {
        showToast(`${from || "Peer"} reacted: ${payload}`);
      }
    };

    function sendEmoji(emoji) {
      ws.send(JSON.stringify({ type: "emoji", roomId, payload: emoji, from: userName }));
      showToast(`You sent: ${emoji}`);
    }

    // Controls
    let micOn = true, camOn = true;

    document.getElementById("mute-btn").onclick = () => {
      micOn = !micOn;
      localStream.getAudioTracks()[0].enabled = micOn;
      document.getElementById("mute-btn").textContent = micOn ? "Mute" : "Unmute";
    };

    document.getElementById("camera-btn").onclick = () => {
      camOn = !camOn;
      localStream.getVideoTracks()[0].enabled = camOn;
      document.getElementById("camera-btn").textContent = camOn ? "Hide Camera" : "Show Camera";
    };

    document.getElementById("audio-only-btn").onclick = () => {
      localStream.getVideoTracks()[0].enabled = false;
      showToast("Switched to audio-only mode.");
    };

    document.getElementById("flip-btn").onclick = async () => {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(d => d.kind === "videoinput");
      if (videoDevices.length > 1) {
        const currentIndex = videoDevices.findIndex(d => d.deviceId === videoInputDeviceId);
        const nextDevice = videoDevices[(currentIndex + 1) % videoDevices.length];
        videoInputDeviceId = nextDevice.deviceId;
        localStream.getTracks().forEach(t => t.stop());
        peer.getSenders().forEach(s => peer.removeTrack(s));
        initStream();
        showToast("Switched camera");
      }
    };
  </script>
</body>
</html>
