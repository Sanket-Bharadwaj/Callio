<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Callio Room</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--bg: #0f172a;--card:#1e293b;--text:#f1f5f9;--accent:#3b82f6;--border:#334155}
    body { background: var(--bg); color: var(--text); font-family: Inter, sans-serif; margin:0; display:flex; flex-direction:column; min-height:100vh}
    header{padding:1rem; background:var(--card); display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border)}
    main#videos { flex:1; position: relative; display:flex; flex-wrap: wrap; justify-content:center; align-items:center;}
    .video-container{position:relative; margin:0.5rem;}
    .video-container video{width:240px; height:180px; background:#000; border-radius:8px; object-fit:cover;}
    .user-tag{position:absolute; bottom:4px; left:4px; background:rgba(0,0,0,0.6); color:#fff; padding:2px 4px; border-radius:4px; font-size:0.75rem;}
    .controls{display:flex; gap:1rem; padding:1rem; background:var(--card); justify-content:center;}
    .control-btn{padding:0.5rem; background:var(--accent); border:none; border-radius:8px; cursor:pointer; color:#fff;}
    .control-btn.off{background:#ef4444}
    .control-btn.on{background:#22c55e}
    .toast{position:fixed; bottom:1rem; right:1rem; background:var(--card); color:#fff; padding:0.75rem 1rem; border-radius:8px; animation:fade 3s forwards}
    @keyframes fade{to{opacity:0}}
    .emoji-overlay{position:absolute; font-size:2rem; animation:fade 1.2s forwards;}
  </style>
</head>
<body>
  <header>
    <div>Room: <span id="room-code" class="font-semibold text-blue-400"></span></div>
    <div class="flex gap-2">
      <button id="share-btn" class="control-btn">Share</button>
      <button id="leave-btn" class="control-btn">Leave</button>
    </div>
  </header>

  <main id="videos"></main>

  <div class="controls">
    <button id="mute-btn" class="control-btn off">ðŸŽ¤</button>
    <button id="camera-btn" class="control-btn off">ðŸ“·</button>
    <button id="flip-btn" class="control-btn">ðŸ”„</button>
    <button id="emoji-btn" class="control-btn">ðŸ˜Š</button>
  </div>

  <div id="toast" class="toast hidden"><span id="toastMessage"></span></div>

  <script>
  const ws = new WebSocket("wss://callio.onrender.com");
  const roomId = new URLSearchParams(location.search).get("id");
  const userName = localStorage.getItem("userName") || prompt("Enter name") || "You";
  localStorage.setItem("userName", userName);
  document.getElementById("room-code").textContent = roomId;

  let localStream, currentCamId, micOn=false, camOn=false;
  const peers = {}, containers = {}, streams = {};

  function showToast(msg){
    const t = document.getElementById("toast");
    document.getElementById("toastMessage").textContent = msg;
    t.classList.remove("hidden");
    setTimeout(()=>t.classList.add("hidden"), 3000);
  }

  function showEmoji(el, emoji){
    const o = document.createElement("div");
    o.className = "emoji-overlay";
    o.textContent = emoji;
    el.parentNode.appendChild(o);
    setTimeout(()=>o.remove(), 1200);
  }

  async function startLocal(){
    const cams = await navigator.mediaDevices.enumerateDevices();
    const vidInputs = cams.filter(d => d.kind === "videoinput");
    currentCamId = vidInputs[0]?.deviceId;
    localStream = await navigator.mediaDevices.getUserMedia({
      audio: true,
      video: currentCamId ? { deviceId: { exact: currentCamId } } : true
    });
    localStream.getAudioTracks()[0].enabled = micOn;
    localStream.getVideoTracks()[0].enabled = camOn;
    addVideo(userName, localStream, true);
    showToast("Local ready");
  }

  function addVideo(name, stream, isLocal){
    if(containers[name]) return;
    const div = document.createElement("div");
    div.className = "video-container";
    const video = document.createElement("video");
    video.autoplay = true;
    video.playsInline = true;
    video.srcObject = stream;
    if(isLocal) video.muted = true;
    const tag = document.createElement("div");
    tag.className = "user-tag";
    tag.textContent = name;
    div.appendChild(video);
    div.appendChild(tag);
    document.getElementById("videos").appendChild(div);
    containers[name] = video;
    streams[name] = stream;
  }

  function createPeer(peerName, initiator){
    if(!localStream) return;
    if(peers[peerName]) return;
    const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
    peers[peerName] = pc;

    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
    pc.ontrack = e => {
      if(!streams[peerName]){
        const ms = new MediaStream();
        addVideo(peerName, ms, false);
        streams[peerName] = ms;
      }
      streams[peerName].addTrack(e.track);
    };
    pc.onicecandidate = e => {
      if(e.candidate){
        ws.send(JSON.stringify({
          type: "signal",
          roomId,
          to: peerName,
          from: userName,
          payload: { candidate: e.candidate }
        }));
      }
    };
    pc.onconnectionstatechange = () => {
      if(pc.connectionState === "disconnected" || pc.connectionState === "failed"){
        showToast(`${peerName} disconnected`);
        pc.close();
        delete peers[peerName];
        containers[peerName]?.parentNode.remove();
        delete containers[peerName];
      }
    };

    if(initiator){
      pc.createOffer()
        .then(o => {
          pc.setLocalDescription(o);
          ws.send(JSON.stringify({
            type: "signal",
            roomId,
            to: peerName,
            from: userName,
            payload: { sdp: o }
          }));
        });
    }
  }

  ws.onopen = () => {
    ws.send(JSON.stringify({ type: "join", roomId, from: userName }));
    startLocal();
  };

  ws.onmessage = async msg => {
    const data = JSON.parse(msg.data);
    if(data.type === "joined"){
      for(const m of data.members){
        if(m !== userName) createPeer(m, true);
      }
      showToast(`${data.members.length} in room`);
    }
    if(data.type === "signal"){
      const pcName = data.from;
      if(!peers[pcName]) createPeer(pcName, false);
      const pc = peers[pcName];
      if(data.payload.sdp){
        await pc.setRemoteDescription(new RTCSessionDescription(data.payload.sdp));
        if(data.payload.sdp.type === "offer"){
          const ans = await pc.createAnswer();
          pc.setLocalDescription(ans);
          ws.send(JSON.stringify({
            type: "signal",
            roomId,
            to: pcName,
            from: userName,
            payload: { sdp: ans }
          }));
        }
      }
      if(data.payload.candidate){
        await pc.addIceCandidate(new RTCIceCandidate(data.payload.candidate));
      }
    }
    if(data.type === "emoji"){
      showEmoji(containers[data.from], data.emoji);
      showToast(`${data.from}: ${data.emoji}`);
    }
  };

  document.getElementById("mute-btn").onclick = () => {
    micOn = !micOn;
    localStream.getAudioTracks()[0].enabled = micOn;
    const btn = document.getElementById("mute-btn");
    btn.classList.toggle("off", !micOn);
    btn.classList.toggle("on", micOn);
    showToast(micOn ? "Unmuted" : "Muted");
  };

  document.getElementById("camera-btn").onclick = () => {
    camOn = !camOn;
    localStream.getVideoTracks()[0].enabled = camOn;
    const btn = document.getElementById("camera-btn");
    btn.classList.toggle("off", !camOn);
    btn.classList.toggle("on", camOn);
    showToast(camOn ? "Camera On" : "Camera Off");
  };

  document.getElementById("flip-btn").onclick = async () => {
    const cams = (await navigator.mediaDevices.enumerateDevices()).filter(d => d.kind === 'videoinput');
    const idx = cams.findIndex(c => c.deviceId === currentCamId);
    currentCamId = cams[(idx + 1) % cams.length].deviceId;
    const newStream = await navigator.mediaDevices.getUserMedia({
      video: { deviceId: { exact: currentCamId } },
      audio: true
    });
    localStream.getTracks().forEach(t => t.stop());
    localStream = newStream;
    localStream.getAudioTracks()[0].enabled = micOn;
    localStream.getVideoTracks()[0].enabled = camOn;
    containers[userName].srcObject = newStream;
    for(const pc of Object.values(peers)){
      const vs = pc.getSenders().find(s => s.track.kind === 'video');
      vs && vs.replaceTrack(localStream.getVideoTracks()[0]);
      const as = pc.getSenders().find(s => s.track.kind === 'audio');
      as && as.replaceTrack(localStream.getAudioTracks()[0]);
    }
    showToast("Camera switched");
  };

  document.getElementById("emoji-btn").onclick = () => {
    const e = prompt("Send emoji:");
    if(e){
      ws.send(JSON.stringify({ type: "emoji", roomId, from: userName, emoji: e }));
      showEmoji(containers[userName], e);
    }
  };

  document.getElementById("share-btn").onclick = () => {
    navigator.clipboard.writeText(location.href).then(() => {
      showToast("Link copied");
    });
  };

  document.getElementById("leave-btn").onclick = () => {
    localStream?.getTracks().forEach(t => t.stop());
    for(const pc of Object.values(peers)) pc.close();
    ws.close();
    window.location.href = "index.html";
  };
  </script>
</body>
</html>
