<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Callio Room</title>
  <style>
    * { margin:0;box-sizing:border-box; font-family:sans-serif; }
    body { display:flex; flex-direction:column; height:100vh; background:#0f172a; color:#f1f5f9; }
    header { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:#1e293b; }
    header h2 { font-size:1rem; }
    main { flex:1; display:flex; position:relative; background:#111827; justify-content:center; align-items:center; }
    .video-large { position:relative; width:100%; max-width:800px; max-height:80%; }
    video { width:100%; height:100%; background:black; border-radius:8px; object-fit:cover; }
    .video-small { position:absolute; bottom:16px; right:16px; width:120px; height:90px; background:#1e293b; border-radius:8px; overflow:hidden; border:2px solid #334155; }
    .controls { display:flex; justify-content:center; gap:12px; padding:12px; background:#1e293b; }
    .controls button { background:#3b82f6; border:none; padding:8px 12px; color:white; font-size:1rem; border-radius:8px; cursor:pointer; }
    #toasts { position: fixed; bottom:12px; right:12px; display:flex; flex-direction:column; gap:8px; }
    .toast { background:#334155; padding:8px 12px; border-radius:6px; color:white; min-width:160px; }
    #waitingOverlay { position:absolute; inset:0; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; color:#f1f5f9; font-size:1.2rem; visibility:hidden; }
    .emoji-bar { display:flex; gap:8px; margin-top:8px; justify-content:center;}
    .emoji-bar span { cursor:pointer; font-size:1.5rem; }
    button:disabled { opacity:0.5; cursor:not-allowed; }
  </style>
</head>
<body>
  <header>
    <h2>Room: <span id="roomCode"></span></h2>
    <button id="leaveBtn">ğŸšª Leave</button>
  </header>

  <main>
    <div id="waitingOverlay">Waiting for someone to join...</div>
    <div class="video-large"><video id="remoteVideo" autoplay playsinline></video></div>
    <div class="video-small"><video id="localVideo" autoplay muted playsinline></video></div>
  </main>

  <div class="controls">
    <button id="micBtn">ğŸ¤</button>
    <button id="camBtn">ğŸ“·</button>
    <button id="audioOnlyBtn">ğŸ”ˆ Mode</button>
    <button id="emojiBtn">ğŸ˜Š</button>
    <button id="shareBtn">ğŸ”— Share</button>
  </div>
  <div class="emoji-bar" id="emojiBar" style="display:none;">
    <span onclick="sendEmoji('ğŸ‘')">ğŸ‘</span><span onclick="sendEmoji('ğŸ‘‹')">ğŸ‘‹</span><span onclick="sendEmoji('ğŸ˜‚')">ğŸ˜‚</span><span onclick="sendEmoji('ğŸ˜®')">ğŸ˜®</span>
  </div>
  <div id="toasts"></div>

  <script>
    const logToast = msg => {
      const t = document.createElement('div');
      t.className='toast'; t.textContent=msg;
      document.getElementById('toasts').append(t);
      setTimeout(()=>t.remove(),3000);
    };

    const roomId = new URLSearchParams(location.search).get('id');
    const userName = localStorage.getItem('userName') || 'You';
    document.getElementById('roomCode').textContent = roomId;

    document.getElementById('leaveBtn').onclick = () => window.location.href = 'index.html';

    document.getElementById('shareBtn').onclick = () => {
      const link = `${location.origin}${location.pathname}?id=${roomId}`;
      navigator.clipboard.writeText(link).then(() => logToast('Copied invite link'));
    };

    const micBtn = document.getElementById('micBtn');
    const camBtn = document.getElementById('camBtn');
    const audioOnlyBtn = document.getElementById('audioOnlyBtn');
    const emojiBtn = document.getElementById('emojiBtn');
    const emojiBar = document.getElementById('emojiBar');
    let micOn = true, camOn = true, audioOnly=false;

    micBtn.onclick = () => {
      micOn = !micOn; localStream.getAudioTracks()[0].enabled = micOn;
      micBtn.textContent = micOn ? 'ğŸ¤' : 'ğŸ”‡';
      logToast(micOn ? 'Microphone unmuted' : 'Microphone muted');
    };
    camBtn.onclick = () => {
      camOn = !camOn; localStream.getVideoTracks()[0].enabled = camOn;
      camBtn.textContent = camOn ? 'ğŸ“·' : 'ğŸš«';
      logToast(camOn ? 'Camera on' : 'Camera off');
    };
    audioOnlyBtn.onclick = () => {
      audioOnly = !audioOnly;
      localStream.getVideoTracks()[0].enabled = !audioOnly;
      audioOnlyBtn.textContent = audioOnly ? 'ğŸ§ Mode' : 'ğŸ”ˆ Mode';
      logToast(audioOnly ? 'Audioâ€‘only mode' : 'Video mode');
    };
    emojiBtn.onclick = () => emojiBar.style.display = emojiBar.style.display==='none' ? 'flex' : 'none';

    function sendEmoji(e) {
      logToast(`You reacted: ${e}`);
      ws.send(JSON.stringify({ type:'emoji', roomId, payload:e }));
      emojiBar.style.display='none';
    }

    const localVideo = document.getElementById('localVideo'),
          remoteVideo = document.getElementById('remoteVideo'),
          waiting = document.getElementById('waitingOverlay');

    let localStream, peer, ws = new WebSocket('wss://callio.onrender.com');
    const config = { iceServers:[{ urls:"stun:stun.l.google.com:19302" }] };

    function checkWaiting() {
      if(!remoteVideo.srcObject || remoteVideo.srcObject.getTracks().length===0) waiting.style.visibility = 'visible';
      else waiting.style.visibility = 'hidden';
    }

    ws.onopen = () => ws.send(JSON.stringify({ type:'join', roomId, name:userName }));

    ws.onmessage = async m => {
      const msg = JSON.parse(m.data);
      if(msg.type==='joined' && msg.name!==userName) {
        logToast(`${msg.name} joined`);
        createPeer(true, msg.name);
      }
      if(msg.type==='signal') {
        if(!peer) createPeer(false,msg.from);
        if(msg.payload.sdp){
          await peer.setRemoteDescription(msg.payload.sdp);
          if(msg.payload.sdp.type==='offer'){
            const ans = await peer.createAnswer();
            await peer.setLocalDescription(ans);
            ws.send(JSON.stringify({ type:'signal', roomId, to:msg.from, payload:{ sdp:ans } }));
          }
        }
        if(msg.payload.candidate) await peer.addIceCandidate(msg.payload.candidate);
      }
      if(msg.type==='emoji' && msg.payload) logToast(`${msg.from} reacted: ${msg.payload}`);
    };

    function createPeer(isInitiator, remoteName) {
      peer = new RTCPeerConnection(config);
      localStream.getTracks().forEach(t=>peer.addTrack(t,localStream));

      peer.ontrack = e => {
        remoteVideo.srcObject = e.streams[0];
        document.querySelector('header h2').textContent = `Room: ${roomId} â€¢ ${remoteName}`;
        checkWaiting();
      };

      peer.onicecandidate = e => {
        if(e.candidate) ws.send(JSON.stringify({ type:'signal', roomId, to:remoteName, payload:{ candidate:e.candidate } }));
      };

      if(isInitiator) {
        peer.createOffer().then(o=>peer.setLocalDescription(o)).then(()=>{
          ws.send(JSON.stringify({ type:'signal', roomId, to:remoteName, payload:{ sdp:peer.localDescription } }));
        });
      }
    }

    navigator.mediaDevices.getUserMedia({ video:true, audio:true })
      .then(s => { localStream = s; localVideo.srcObject = s; checkWaiting(); })
      .catch(e=>alert('Mic/cam error: '+e));
  </script>
</body>
</html>
