<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Callio Room</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #f1f5f9;
      --accent: #3b82f6;
      --border: #334155;
    }
    body {
      margin: 0;
      font-family: sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: var(--card);
      border-bottom: 1px solid var(--border);
    }
    header button {
      margin-left: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    main {
      flex: 1;
      position: relative;
      background: black;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #remote-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: var(--card);
      border-top: 1px solid var(--border);
    }
    .controls button {
      padding: 0.5rem 1rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #toast {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card);
      color: var(--text);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      display: none;
    }
    .emoji {
      position: absolute;
      font-size: 3rem;
      animation: fade 1s ease-out;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    @keyframes fade {
      from { opacity: 1; }
      to { opacity: 0; transform: translateY(-50px); }
    }
  </style>
</head>
<body>
  <header>
    <div>Room: <strong id="room-code"></strong></div>
    <div>
      <button id="share-btn">Share</button>
      <button id="leave-btn">Leave</button>
    </div>
  </header>

  <main>
    <video id="remote-video" autoplay playsinline></video>
    <video id="local-video" autoplay muted playsinline style="position: absolute; bottom: 80px; right: 10px; width: 150px; border: 2px solid var(--border);"></video>
  </main>

  <div class="controls">
    <button id="mute-btn">Mic Off</button>
    <button id="camera-btn">Cam Off</button>
    <button id="flip-btn">Flip Cam</button>
    <button id="emoji-btn">Emoji</button>
  </div>

  <div id="toast"></div>

  <script>
    const ws = new WebSocket("wss://callio.onrender.com");
    const roomId = new URLSearchParams(location.search).get("id");
    const userName = localStorage.getItem("userName") || prompt("Enter name") || "You";
    localStorage.setItem("userName", userName);
    document.getElementById("room-code").textContent = roomId;

    const remoteVideo = document.getElementById("remote-video");
    const localVideo = document.getElementById("local-video");
    const peers = {};
    let localStream, videoDeviceId = null;

    function showToast(msg) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.display = "block";
      setTimeout(() => t.style.display = "none", 2000);
    }

    async function getMedia() {
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: true,
        video: videoDeviceId ? { deviceId: { exact: videoDeviceId } } : true
      });
      localStream = stream;
      localVideo.srcObject = stream;
      updateButtons();
    }

    function updateButtons() {
      document.getElementById("mute-btn").textContent = localStream.getAudioTracks()[0].enabled ? "Mic On" : "Mic Off";
      document.getElementById("camera-btn").textContent = localStream.getVideoTracks()[0].enabled ? "Cam On" : "Cam Off";
    }

    function createPeer(isInitiator) {
      const peer = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });
      localStream.getTracks().forEach(t => peer.addTrack(t, localStream));

      peer.ontrack = e => {
        remoteVideo.srcObject = e.streams[0];
      };

      peer.onicecandidate = e => {
        if (e.candidate) {
          ws.send(JSON.stringify({ type: "signal", roomId, from: userName, payload: { candidate: e.candidate } }));
        }
      };

      if (isInitiator) {
        peer.createOffer().then(o => {
          peer.setLocalDescription(o);
          ws.send(JSON.stringify({ type: "signal", roomId, from: userName, payload: { sdp: o } }));
        });
      }

      peers[roomId] = peer;
    }

    ws.onopen = () => {
      ws.send(JSON.stringify({ type: "join", roomId, name: userName }));
      getMedia();
    };

    ws.onmessage = async msg => {
      const data = JSON.parse(msg.data);
      const { type, payload } = data;

      if (type === "joined") {
        createPeer(true);
        showToast("Peer joined");
      }

      if (type === "signal") {
        if (!peers[roomId]) createPeer(false);
        const peer = peers[roomId];
        if (payload.sdp) {
          await peer.setRemoteDescription(payload.sdp);
          if (payload.sdp.type === "offer") {
            const ans = await peer.createAnswer();
            peer.setLocalDescription(ans);
            ws.send(JSON.stringify({ type: "signal", roomId, from: userName, payload: { sdp: ans } }));
          }
        } else if (payload.candidate) {
          await peer.addIceCandidate(payload.candidate);
        }
      }

      if (type === "emoji") {
        const e = document.createElement("div");
        e.className = "emoji";
        e.textContent = payload.emoji;
        remoteVideo.parentElement.appendChild(e);
        setTimeout(() => e.remove(), 1000);
      }
    };

    document.getElementById("share-btn").onclick = () => {
      navigator.clipboard.writeText(location.href)
        .then(() => showToast("Link copied"));
    };

    document.getElementById("leave-btn").onclick = () => {
      localStream.getTracks().forEach(t => t.stop());
      ws.close();
      window.location.href = "index.html";
    };

    document.getElementById("mute-btn").onclick = () => {
      const t = localStream.getAudioTracks()[0];
      t.enabled = !t.enabled;
      updateButtons();
      showToast(t.enabled ? "Mic On" : "Mic Off");
    };

    document.getElementById("camera-btn").onclick = () => {
      const t = localStream.getVideoTracks()[0];
      t.enabled = !t.enabled;
      localVideo.style.display = t.enabled ? "block" : "none";
      updateButtons();
      showToast(t.enabled ? "Cam On" : "Cam Off");
    };

    document.getElementById("flip-btn").onclick = async () => {
      const cams = (await navigator.mediaDevices.enumerateDevices())
        .filter(d => d.kind === "videoinput");
      if (cams.length < 2) return showToast("No other cam");
      const idx = cams.findIndex(c => c.deviceId === videoDeviceId);
      videoDeviceId = cams[(idx + 1) % cams.length].deviceId;
      await getMedia();
      const peer = peers[roomId];
      const sender = peer.getSenders().find(s => s.track.kind === "video");
      sender.replaceTrack(localStream.getVideoTracks()[0]);
      showToast("Camera flipped");
    };

    document.getElementById("emoji-btn").onclick = () => {
      const emoji = prompt("Enter emoji:");
      if (emoji) {
        ws.send(JSON.stringify({ type: "emoji", roomId, payload: { emoji } }));
      }
    };
  </script>
</body>
</html>
