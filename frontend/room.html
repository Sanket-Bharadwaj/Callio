<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Callio Room</title>
  <style>
    :root {
      --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --accent: #3b82f6; --border: #334155;
    }
    body { background: var(--bg); color: var(--text); font-family: sans-serif; margin:0; }
    header { display:flex; justify-content:space-between; align-items:center; padding:12px; background:var(--card); }
    header h2 { margin:0; font-size:1rem; }
    header button { background:var(--accent); border:none; color:white; padding:6px 12px; border-radius:6px; cursor:pointer; }
    main { display:flex; flex-wrap: wrap; gap:12px; padding:12px; justify-content:center; }
    .video-container { position:relative; }
    .video-container video { width:240px; height:180px; background:black; border-radius:8px; border:2px solid var(--border); object-fit:cover; }
    .video-container .user-tag { position:absolute; bottom:4px; left:4px; font-size:0.75rem; background:rgba(0,0,0,0.6); padding:2px 4px; border-radius:4px; }
    .controls { display:flex; flex-wrap: wrap; gap:8px; padding:12px; background:var(--card); justify-content:center; }
    .controls button { background:var(--accent); border:none; color:white; padding:8px 12px; border-radius:6px; cursor:pointer; }
    .emoji-overlay { font-size:3rem; position:absolute; pointer-events:none; animation:fade 1.2s; }
    @keyframes fade { 0%{opacity:1;}100%{opacity:0;} }
    .toast { position:fixed; bottom:16px; right:16px; background:var(--card); color:var(--text); padding:8px 12px; border-radius:6px; animation:fade 3s forwards; }
  </style>
</head>
<body>
  <header>
    <h2>Room: <span id="room-code"></span></h2>
    <button id="leave-btn">Leave</button>
  </header>
  <main id="videos"></main>
  <div class="controls">
    <button id="mute-btn">ğŸ¤</button>
    <button id="camera-btn">ğŸ“·</button>
    <button id="flip-btn">ğŸ”</button>
    <button id="audio-btn">ğŸ”ˆ</button>
    <button id="emoji-btn">ğŸ˜Š</button>
    <button id="share-btn">ğŸ”—</button>
  </div>
  <script>
    const ws = new WebSocket("wss://callio.onrender.com");
    const roomId = new URLSearchParams(location.search).get("id");
    const userName = localStorage.getItem("userName") || "You";
    const videos = document.getElementById("videos");
    document.getElementById("room-code").textContent = roomId;

    function showToast(msg){
      const t = document.createElement("div"); t.className="toast"; t.textContent=msg;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(),3000);
    }

    function showEmoji(el, emoji){
      const o = document.createElement("div");
      o.className="emoji-overlay"; o.textContent=emoji;
      el.parentNode.append(o);
      setTimeout(()=>o.remove(),1200);
    }

    let localStream, videoDeviceId=null;
    const peers = {}, containers = {};

    async function initLocal(){
      const stream = await navigator.mediaDevices.getUserMedia({
        video: videoDeviceId ? { deviceId:videoDeviceId } : true,
        audio:true
      });
      localStream = stream;
      addVideo("You", stream, true);
    }

    function addVideo(name, stream, isLocal){
      if(containers[name]) return;
      const div = document.createElement("div");
      div.className="video-container";
      const vid = document.createElement("video");
      vid.autoplay = vid.playsInline = true;
      vid.srcObject = stream;
      div.appendChild(vid);
      const tag = document.createElement("div");
      tag.className="user-tag"; tag.textContent = name;
      div.appendChild(tag);
      videos.appendChild(div);
      containers[name] = vid;
    }

    function createPeer(name, initiator){
      if(peers[name]) return;
      const peer = new RTCPeerConnection({ iceServers:[{urls:"stun:stun.l.google.com:19302"}] });
      localStream.getTracks().forEach(t=>peer.addTrack(t, localStream));
      peer.ontrack = e=>{
        const stream = e.streams[0];
        addVideo(name, stream, false);
      };
      peer.onicecandidate = e=>{
        if(e.candidate) ws.send(JSON.stringify({type:"signal", roomId, to:name, from:userName, payload:{candidate:e.candidate}}));
      };
      peers[name] = peer;
      if(initiator){
        peer.createOffer().then(o=>{
          peer.setLocalDescription(o);
          ws.send(JSON.stringify({type:"signal", roomId, to:name, from:userName, payload:{sdp:o}}));
        });
      }
    }

    ws.onopen = ()=>{
      ws.send(JSON.stringify({type:"join", roomId, name:userName}));
      initLocal();
    };

    ws.onmessage = async m=>{
      const data = JSON.parse(m.data);
      const { type, from, payload, members, emoji } = data;
      if(type==="joined"){
        members.forEach(m=>{ if(m!==userName) createPeer(m, true); });
        showToast(`${from} joined`);
      }
      if(type==="signal"){
        if(!peers[from]) createPeer(from, false);
        const peer = peers[from];
        if(payload.sdp){
          await peer.setRemoteDescription(new RTCSessionDescription(payload.sdp));
          if(payload.sdp.type === "offer"){
            const ans = await peer.createAnswer();
            peer.setLocalDescription(ans);
            ws.send(JSON.stringify({type:"signal", roomId, to:from, from:userName, payload:{sdp:ans}}));
          }
        }
        if(payload.candidate) peer.addIceCandidate(new RTCIceCandidate(payload.candidate));
      }
      if(type==="emoji"){
        const vid = containers[from];
        if(vid) showEmoji(vid, emoji);
        showToast(`${from}: ${emoji}`);
      }
    };

    document.getElementById("mute-btn").onclick = ()=>{
      const t = localStream.getAudioTracks()[0];
      t.enabled = !t.enabled;
      showToast(t.enabled ? "Unmuted" : "Muted");
    };

    document.getElementById("camera-btn").onclick = ()=>{
      const t = localStream.getVideoTracks()[0];
      t.enabled = !t.enabled;
      showToast(t.enabled ? "Cam On" : "Cam Off");
    };

    document.getElementById("flip-btn").onclick = async ()=>{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const vids = devices.filter(d=>d.kind==="videoinput");
      if(vids.length>1){
        const idx = vids.findIndex(d=>d.deviceId===videoDeviceId);
        videoDeviceId = vids[(idx+1)%vids.length].deviceId;
        await initLocal();
        Object.values(peers).forEach(p=>{
          const sender = p.getSenders().find(s=>s.track.kind==="video");
          sender.replaceTrack(localStream.getVideoTracks()[0]);
        });
        showToast("Camera switched");
      }
    };

    document.getElementById("audio-btn").onclick = ()=>{
      const t = localStream.getVideoTracks()[0];
      t.enabled = false;
      showToast("Audio-only mode");
    };

    document.getElementById("emoji-btn").onclick = ()=>{
      const e = prompt("Send emoji:");
      if(e){
        ws.send(JSON.stringify({type:"emoji", roomId, from:userName, emoji:e}));
        showEmoji(containers[userName], e);
      }
    };

    document.getElementById("share-btn").onclick = ()=>{
      navigator.clipboard.writeText(location.href);
      showToast("Link copied!");
    };

    document.getElementById("leave-btn").onclick = ()=>{
      window.location.href = "index.html";
    };
  </script>
</body>
</html>
