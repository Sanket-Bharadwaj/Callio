<!DOCTYPE html>
<html lang="en">
<head>
  <!-- (Keep your head & style intactâ€”omitted here for brevity) -->
</head>
<body>
  <!-- (Your existing body/UI) -->

  <script>
  const roomId = new URLSearchParams(window.location.search).get('id') || 'no-id';
  const userName = localStorage.getItem('userName') || 'You';

  // --- UI Elements
  const micToggle = document.getElementById('mic-toggle');
  const cameraToggle = document.getElementById('camera-toggle');
  const endCallBtn = document.getElementById('end-call');
  const localVideo = document.getElementById('local-video');
  const remoteVideo = document.getElementById('remote-video');
  const localAvatar = document.getElementById('local-avatar');
  const remoteAvatar = document.getElementById('remote-avatar');
  document.getElementById('local-name').textContent = userName;
  document.getElementById('local-avatar-text').textContent = userName.charAt(0).toUpperCase();

  // --- WebSocket Signaling
  const socket = new WebSocket('wss://callio.onrender.com');

  socket.addEventListener('open', () => {
    console.log('ðŸ”Œ WebSocket connected');
    socket.send(JSON.stringify({ type: 'join', roomId }));
  });

  socket.addEventListener('message', async e => {
    const msg = JSON.parse(e.data);
    if (!pc) return;

    if (msg.type === 'signal') {
      const data = msg.payload;
      if (data.sdp) {
        await pc.setRemoteDescription(data);
        if (data.type === 'offer') {
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          socket.send(JSON.stringify({ type: 'signal', roomId, payload: pc.localDescription }));
        }
      } else if (data.candidate) {
        await pc.addIceCandidate(data);
      }
    }
  });

  // --- Set up WebRTC Peer Connection
  let pc;
  let localStream;

  async function startMedia() {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
    localVideo.srcObject = localStream;
    joinCall();
  }

  function joinCall() {
    pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    pc.onicecandidate = e => {
      if (e.candidate) {
        socket.send(JSON.stringify({ type: 'signal', roomId, payload: e.candidate }));
      }
    };

    pc.ontrack = e => {
      remoteVideo.srcObject = e.streams[0];
      remoteAvatar.style.display = 'none';
      remoteVideo.style.display = 'block';
    };

    socket.addEventListener('open', () => {}); // initial join
    // Let server logic handle caller/callee roles

    pc.onnegotiationneeded = async () => {
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.send(JSON.stringify({ type: 'signal', roomId, payload: pc.localDescription }));
    };
  }

  // --- Control Toggles
  micToggle.addEventListener('click', () => {
    const track = localStream.getAudioTracks()[0];
    track.enabled = !(track.enabled);
    micToggle.textContent = track.enabled ? 'ðŸŽ¤' : 'ðŸ”‡';
  });

  cameraToggle.addEventListener('click', () => {
    // optional: if you add video later
  });

  endCallBtn.addEventListener('click', () => location.href = 'index.html');
  
  // --- Start everything
  startMedia().catch(console.error);
  </script>
</body>
</html>
